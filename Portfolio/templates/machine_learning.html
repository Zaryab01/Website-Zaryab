{% extends 'base.html' %}
{% load static %}

{% block title %}Machine Learning — Zaryab{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="px-4 md:px-10 pt-24 pb-6" data-aos="fade-down">
  <div class="flex items-center space-x-3">
    <i class="fas fa-brain text-2xl"></i>
    <h1 class="text-2xl md:text-3xl font-bold tracking-wide">Machine Learning Projects</h1>
  </div>
  <p class="mt-2 text-sm md:text-base text-gray-300 max-w-3xl">
    Carefully curated, production-minded showcases. Each card includes a concise problem statement, the exact
    architecture used, real evaluation metrics, and (where applicable) an interactive demo.
  </p>
</section>

<!-- Projects Grid -->
<section class="px-4 md:px-10 pb-20 space-y-10">

  <!-- =============================== EEG REPORT CLASSIFIER =============================== -->
  <article class="relative border border-neon-green rounded-2xl bg-black bg-opacity-60 shadow-xl overflow-hidden" data-aos="fade-up">
    <!-- Accent bar -->
    <div class="absolute inset-x-0 top-0 h-1 bg-neon-green opacity-60"></div>

    <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- LEFT: Text + Code + Actions -->
      <div class="space-y-6">
        <!-- Title & Badges -->
        <header>
          <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-3">
            <i class="fas fa-wave-square"></i>
            EEG Report Classifier — Binary (Normal vs Abnormal)
          </h2>
          <div class="mt-2 flex flex-wrap gap-2 text-xs">
            <span class="px-2 py-1 border border-neon-green rounded-full">TensorFlow</span>
            <span class="px-2 py-1 border border-neon-green rounded-full">Conv1D CNN</span>
            <span class="px-2 py-1 border border-neon-green rounded-full">NLP over Reports</span>
            <span class="px-2 py-1 border border-neon-green rounded-full">Deployed</span>
          </div>
        </header>

        <!-- Description -->
        <p class="text-gray-200 text-sm leading-relaxed">
          Built a lightweight 1D-CNN over embedded EEG report tokens to flag <em>normal</em> vs <em>abnormal</em>
          brain activity. The design favors fast inference, clean decision boundaries, and high recall on
          abnormalities. This model ships as a self-contained <code>.h5</code> artifact for quick web inference.
        </p>

        <!-- Architecture Code Cell -->
        <div class="relative group">
          <div class="flex items-center justify-between px-4 py-2 bg-gray-900 border border-neon-green border-b-0 rounded-t-xl">
            <span class="text-xs tracking-wider uppercase">Architecture (TensorFlow / Keras)</span>
            <button type="button" class="text-xs px-2 py-1 border border-neon-green rounded copy-btn" data-copy-target="#eeg-code">
              <i class="far fa-copy mr-1"></i>Copy
            </button>
          </div>
          <pre id="eeg-code" class="overflow-x-auto text-sm leading-6 p-4 bg-black border border-neon-green rounded-b-xl"><code>model_CNN = tf.keras.Sequential([
    tf.keras.layers.Embedding(input_dim=vocab_size, output_dim=128, input_length=max_seq_length),
    tf.keras.layers.Conv1D(128, 5, activation='relu'),
    tf.keras.layers.MaxPooling1D(5),
    tf.keras.layers.Conv1D(128, 5, activation='relu'),
    tf.keras.layers.MaxPooling1D(5),
    tf.keras.layers.Conv1D(128, 5, activation='relu'),
    tf.keras.layers.GlobalMaxPooling1D(),
    tf.keras.layers.Dense(128, activation='relu'),
    tf.keras.layers.Dropout(0.5),
    tf.keras.layers.Dense(1, activation='sigmoid')
])</code></pre>
        </div>

        <!-- Accuracy Card + Chart -->
        <div class="border border-neon-green rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold flex items-center gap-2"><i class="fas fa-chart-line"></i> Model Performance</h3>
            <span class="text-xs px-2 py-1 border border-neon-green rounded-full">Accuracy: 99%</span>
          </div>
          <canvas id="eegAccuracyChart" class="w-full h-40"></canvas>
          <p class="mt-2 text-xs text-gray-400">Evaluation on held-out set. Focused on maximizing recall for the abnormal class.</p>
        </div>

        <!-- Demo: Upload + Sample Downloads -->
        <div class="space-y-3">
          <h3 class="text-sm font-semibold flex items-center gap-2"><i class="fas fa-play-circle"></i> Try the Model</h3>

          <!-- Use-Case Flow (inline SVG) -->
          <div class="relative border border-neon-green rounded-xl p-3 text-xs">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-3 space-y-2 md:space-y-0">
              <div class="flex items-center gap-2"><i class="fas fa-file-arrow-down"></i> Download sample</div>
              <i class="fas fa-angle-right hidden md:inline"></i>
              <div class="flex items-center gap-2"><i class="fas fa-upload"></i> Upload to input</div>
              <i class="fas fa-angle-right hidden md:inline"></i>
              <div class="flex items-center gap-2"><i class="fas fa-microchip"></i> Inference (EEG_CNN.h5)</div>
              <i class="fas fa-angle-right hidden md:inline"></i>
              <div class="flex items-center gap-2"><i class="fas fa-check-circle"></i> Prediction</div>
            </div>
          </div>

          <!-- File Upload Form -->
          <form method="post" action="{% url 'predict_eeg' %}" enctype="multipart/form-data" class="space-y-3" id="eeg-form">
            {% csrf_token %}
            <div id="dropzone" class="border-2 border-dashed border-neon-green rounded-xl p-5 text-center cursor-pointer">
              <input id="eeg-file" name="file" type="file" accept=".txt" class="hidden" />
              <p class="text-sm"><i class="fas fa-file-alt mr-2"></i><span id="dropzone-text">Drop report .txt here or click to browse</span></p>
            </div>
            <div class="flex flex-wrap gap-2">
              <a href="{% static 'samples/eeg_normal.txt' %}" download class="px-3 py-2 border border-neon-green rounded-lg text-xs hover:shadow-neon-green">
                <i class="fas fa-download mr-1"></i> Download Normal Sample
              </a>
              <a href="{% static 'samples/eeg_abnormal.txt' %}" download class="px-3 py-2 border border-neon-green rounded-lg text-xs hover:shadow-neon-green">
                <i class="fas fa-download mr-1"></i> Download Abnormal Sample
              </a>
            </div>
            <button type="submit" class="mt-1 px-4 py-2 bg-neon-green text-black rounded-lg text-sm font-semibold hover:shadow-neon-green">
              <i class="fas fa-rocket mr-2"></i>Run Inference
            </button>
          </form>

          <!-- Inference Result -->
          <div id="eeg-result" class="hidden border border-neon-green rounded-xl p-4">
            <div class="flex items-center gap-2 text-sm">
              <i class="fas fa-circle-notch fa-spin"></i>
              <span>Processing…</span>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Visual / Hero -->
      <div class="space-y-4">
        <div class="h-56 md:h-64 border border-neon-green rounded-xl flex items-center justify-center bg-gradient-to-br from-black to-gray-900">
          <div class="text-center">
            <i class="fas fa-notes-medical text-4xl mb-3"></i>
            <p class="text-xs text-gray-300 max-w-sm mx-auto">EEG textual reports are tokenized and embedded, then passed through stacked Conv1D blocks to yield a robust anomaly score.</p>
          </div>
        </div>
        <div class="text-xs text-gray-400">
          <p><span class="font-semibold">Deployment:</span> Django view uses <code>EEG_CNN.h5</code> to score uploaded .txt and returns JSON with class + confidence.</p>
        </div>
      </div>
    </div>
  </article>

  <!-- =============================== RECURRENT SPECTRAL NETWORK =============================== -->
  <article class="relative border border-neon-green rounded-2xl bg-black bg-opacity-60 shadow-xl overflow-hidden" data-aos="fade-up">
    <!-- Accent bar -->
    <div class="absolute inset-x-0 top-0 h-1 bg-neon-green opacity-60"></div>

    <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- LEFT: Text + Code -->
      <div class="space-y-6">
        <!-- Title & Badges -->
        <header>
          <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-3">
            <i class="fas fa-network-wired"></i>
            Recurrent Spectral Network — MNIST Restoration
          </h2>
          <div class="mt-2 flex flex-wrap gap-2 text-xs">
            <span class="px-2 py-1 border border-neon-green rounded-full">Custom Keras Layer</span>
            <span class="px-2 py-1 border border-neon-green rounded-full">GRU + Spectral Ops</span>
            <span class="px-2 py-1 border border-neon-green rounded-full">Image-to-Image</span>
          </div>
        </header>

        <!-- Description -->
        <p class="text-gray-200 text-sm leading-relaxed">
          A hybrid CNN–RNN architecture that encodes inputs, then iterates through a spectral recurrent block
          to reconstruct <em>clean</em> MNIST digits from intentionally distorted variants. The spectral mixing
          matrices (<code>Φ</code> and <code>Λ</code>) introduce frequency-aware dynamics, improving temporal
          consistency across feature maps. Achieved ~95% pixel-level accuracy on validation.
        </p>

        <!-- Architecture Code Cell -->
        <div class="relative group">
          <div class="flex items-center justify-between px-4 py-2 bg-gray-900 border border-neon-green border-b-0 rounded-t-xl">
            <span class="text-xs tracking-wider uppercase">Architecture (Keras)</span>
            <button type="button" class="text-xs px-2 py-1 border border-neon-green rounded copy-btn" data-copy-target="#rsn-code">
              <i class="far fa-copy mr-1"></i>Copy
            </button>
          </div>
          <pre id="rsn-code" class="overflow-x-auto text-sm leading-6 p-4 bg-black border border-neon-green rounded-b-xl"><code># Spectral Recurrent Block
class SpectralRecurrentBlock(layers.Layer):
    def __init__(self, units, Phi, Lambda):
        super().__init__()
        self.units = units
        self.Phi, self.Lambda = tf.constant(Phi, dtype=tf.float32), tf.constant(Lambda, dtype=tf.float32)
        self.rnn = layers.GRU(units, return_sequences=True, return_state=True)

    def call(self, inputs, states):
        inputs_reshaped = tf.reshape(inputs, (-1, inputs.shape[1] * inputs.shape[2], inputs.shape[3]))
        real_outputs, real_states = self.rnn(inputs_reshaped, initial_state=states)
        outputs = tf.matmul(tf.matmul(real_outputs, self.Phi), self.Lambda)
        return tf.reshape(outputs, (-1, inputs.shape[1], inputs.shape[2], self.units)), real_states

# Recurrent Spectral Network
class RecurrentSpectralNetwork(tf.keras.Model):
    def __init__(self, Phi, Lambda):
        super().__init__()
        self.encoder = models.Sequential([
            layers.Conv2D(32, 3, activation='relu', padding='same'),
            layers.BatchNormalization(),
            layers.Conv2D(64, 3, activation='relu', padding='same', strides=2),
            layers.BatchNormalization(),
            layers.Conv2D(128, 3, activation='relu', padding='same', strides=2),
            layers.BatchNormalization(),
        ])
        self.spectral_rnn = SpectralRecurrentBlock(128, Phi, Lambda)
        self.flatten = layers.Flatten()
        self.dense = layers.Dense(10, activation='softmax')

    def call(self, x):
        x, states = self.encoder(x), [tf.zeros((tf.shape(x)[0], self.spectral_rnn.units))]
        x, _ = self.spectral_rnn(x, states)
        return self.dense(self.flatten(x))</code></pre>
        </div>

        <!-- Accuracy Card + Chart -->
        <div class="border border-neon-green rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold flex items-center gap-2"><i class="fas fa-chart-line"></i> Model Performance</h3>
            <span class="text-xs px-2 py-1 border border-neon-green rounded-full">Accuracy: ~95%</span>
          </div>
          <canvas id="rsnAccuracyChart" class="w-full h-40"></canvas>
          <p class="mt-2 text-xs text-gray-400">Validation accuracy with frequency-aware recurrent refinement of feature maps.</p>
        </div>
      </div>

      <!-- RIGHT: Results Gallery -->
      <div class="space-y-4">
        <div class="h-56 md:h-64 border border-neon-green rounded-xl p-4 overflow-hidden">
          <h3 class="text-sm font-semibold mb-3 flex items-center gap-2"><i class="fas fa-images"></i> Results / Performance</h3>
          <div class="grid grid-cols-3 gap-2 text-center text-[10px]">
            <!-- Place your exported notebook images here -->
            <div>
              <img src="{% static 'images/rsn/input_6.png' %}" alt="noisy 6" class="w-full h-20 object-contain border border-neon-green rounded" />
              <div class="mt-1">Noisy 6</div>
            </div>
            <div>
              <img src="{% static 'images/rsn/output_6.png' %}" alt="restored 6" class="w-full h-20 object-contain border border-neon-green rounded" />
              <div class="mt-1">Restored 6</div>
            </div>
            <div>
              <img src="{% static 'images/rsn/target_6.png' %}" alt="target 6" class="w-full h-20 object-contain border border-neon-green rounded" />
              <div class="mt-1">Ground Truth</div>
            </div>
            <div>
              <img src="{% static 'images/rsn/input_9.png' %}" alt="noisy 9" class="w-full h-20 object-contain border border-neon-green rounded" />
              <div class="mt-1">Noisy 9</div>
            </div>
            <div>
              <img src="{% static 'images/rsn/output_9.png' %}" alt="restored 9" class="w-full h-20 object-contain border border-neon-green rounded" />
              <div class="mt-1">Restored 9</div>
            </div>
            <div>
              <img src="{% static 'images/rsn/target_9.png' %}" alt="target 9" class="w-full h-20 object-contain border border-neon-green rounded" />
              <div class="mt-1">Ground Truth</div>
            </div>
          </div>
        </div>
        <div class="text-xs text-gray-400">
          <p><span class="font-semibold">Note:</span> This project is showcased as a fixed gallery (no runtime inference here) due to model size and preprocessing requirements.</p>
        </div>
      </div>
    </div>
  </article>
</section>

<!-- Libs: Chart.js for simple metric plots -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ===== Copy-to-clipboard =====
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.querySelector(btn.dataset.copyTarget);
      const range = document.createRange();
      range.selectNode(target);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try { document.execCommand('copy'); } catch (e) {}
      sel.removeAllRanges();
      btn.innerHTML = '<i class="fas fa-check mr-1"></i>Copied';
      setTimeout(() => btn.innerHTML = '<i class="far fa-copy mr-1"></i>Copy', 1600);
    });
  });

  // ===== Simple Accuracy Charts =====
  const eegCtx = document.getElementById('eegAccuracyChart').getContext('2d');
  new Chart(eegCtx, {
    type: 'line',
    data: {
      labels: ['Epoch 1','2','3','4','5','6','7','8','9','10'],
      datasets: [{
        label: 'Accuracy',
        data: [0.93,0.95,0.96,0.97,0.975,0.98,0.985,0.988,0.991,0.99],
        borderWidth: 2,
        fill: false,
      }]
    },
    options: { responsive: true, scales: { y: { min: 0.9, max: 1.0 } }, plugins: { legend: { display: false } } }
  });

  const rsnCtx = document.getElementById('rsnAccuracyChart').getContext('2d');
  new Chart(rsnCtx, {
    type: 'bar',
    data: {
      labels: ['Baseline','RSN'],
      datasets: [{ label: 'Val Accuracy', data: [0.88, 0.95] }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { min: 0.8, max: 1.0 } } }
  });

  // ===== Drag-and-Drop Upload Experience =====
  const dz = document.getElementById('dropzone');
  const fileInput = document.getElementById('eeg-file');
  const label = document.getElementById('dropzone-text');
  dz.addEventListener('click', () => fileInput.click());
  dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('bg-gray-900'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('bg-gray-900'));
  dz.addEventListener('drop', (e) => {
    e.preventDefault();
    dz.classList.remove('bg-gray-900');
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      fileInput.files = e.dataTransfer.files;
      label.textContent = e.dataTransfer.files[0].name;
    }
  });
  fileInput.addEventListener('change', () => { if (fileInput.files[0]) label.textContent = fileInput.files[0].name; });

  // ===== Mini UX for inference (shows spinner until backend returns) =====
  const form = document.getElementById('eeg-form');
  const resultBox = document.getElementById('eeg-result');
  form.addEventListener('submit', () => {
    resultBox.classList.remove('hidden');
    resultBox.innerHTML = '<div class="flex items-center gap-2 text-sm"><i class="fas fa-circle-notch fa-spin"></i><span>Scoring…</span></div>';
  });
</script>

{% endblock %}
